<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Line Chart</title>
    <style>
      body {
        /* height: 100vh; */
        width: 100vw;
        font-family: "Arial", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        overflow-x: scroll;
        overflow-y: scroll;
      }

      #tableContainer {
        width: 80vw;
        height: fit-content;
      }

      .beautiful-table {
        width: 100%;
        border-collapse: collapse;
      }

      .beautiful-table th,
      .beautiful-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
      }

      .beautiful-table th {
        background-color: #f2f2f2;
      }

      .beautiful-table tr:nth-child(even) {
        background-color: #f9f9f9;
      }

      .beautiful-table tr:hover {
        background-color: #e6f7ff;
      }

      .chart-container {
        width: 100vw;
        min-height: 400px; /* Set a minimum height for the chart container */
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        overflow: visible;
      }

      .chart-header {
        background-color: #4caf50;
        color: #fff;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
      }

      .chart-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 15px;
        margin-bottom: 5px;
      }

      .loading-indicator {
        display: none;
        color: #b92d2d;
        margin-left: 10px;
        font-weight: bold;
      }

      canvas {
        background-color: #96c790;
        width: 100%;
        height: fit-content;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
  </head>

  <body>
    <!-- Create a canvas element to render the chart -->
    <div class="chart-container">
      <div class="chart-header">Line Chart</div>
      <div class="chart-controls">
        <input type="date" id="startDate" style="color: #b92d2d" />
        <span style="margin: 0 10px">To</span>
        <input
          type="date"
          id="endDate"
          style="color: #2db950; margin: 0 10px"
        />
        <input type="text" placeholder="Enter a Name" id="name">

        <label for="mySelect">Select Period Of: </label>
        <select style="margin: 0 10px; color: #28cf12" id="mySelect">
          <option value="option1" selected>Monthly</option>
          <option value="option2">Weekly</option>
          <option value="option3">Daily</option>
        </select>
        <button
          type="button"
          onclick="generateDateChart()"
          style="color: #4caf50"
        >
          Generate Date Chart
        </button>
        <div id="loadingIndicator" class="loading-indicator">
          Wait, Chart is Loading...
        </div>
      </div>

      <canvas id="lineChart" width="1000" height="400"></canvas>
    </div>
    <div id="tableContainer">
      <table id="dataTable" class="beautiful-table">
        <!-- Table header -->
        <thead>
          <tr style="color: #c05656">
            <th>Date</th>
            <th>Value</th>
            <th>Loss/Profit</th>
            <th>Monowave</th>
            <th>Retracement (%)</th>
          </tr>
        </thead>
        <!-- Table body will be dynamically generated using JavaScript -->
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <script>
      let a = document.getElementById("Attached");

      function fillTable(
        dateArrayReceive,
        openPrices,
        lossProfitArray,
        MonowaveArray,
        newRetracementArray
      ) {
        const dateArray = dateArrayReceive.map(
          (dateString) => new Date(dateString)
        );

        let FinalArray = new Array();

        for (let i = 0; i < openPrices.length; i++) {
          FinalArray[i] = {
            date: dateArrayReceive[i],
            price: openPrices[i],
            lossprofit: lossProfitArray[i],
            monowave: MonowaveArray[i],
            retracement: newRetracementArray[i],
          };
        }

        const tableBody = document.getElementById("tableBody");

        // Clear previous table content
        tableBody.innerHTML = "";

        // Iterate through the dateArray and create a row for each date
        FinalArray.forEach((date, index) => {
          const row = document.createElement("tr");

          // Add date cell
          const dateCell = document.createElement("td");
          dateCell.textContent = date.date.toLocaleDateString();
          row.appendChild(dateCell);

          // Add value, loss/profit, monowave, and retracement cells (you can replace these with your actual data)

          const valueCell = document.createElement("td");
          if (date.price == "EMpty") {
            valueCell.textContent = "";
          } else {
            let FinalPrice = parseFloat(date.price.toFixed(3));
            valueCell.textContent = FinalPrice;
          }
          row.appendChild(valueCell);

          const lossProfitCell = document.createElement("td");
          if (date.lossprofit == "EMpty") {
            lossProfitCell.textContent = "";
          } else {
            let FinalPrice = parseFloat(date.lossprofit.toFixed(3));

            lossProfitCell.textContent = FinalPrice;
          }
          row.appendChild(lossProfitCell);

          const monowaveCell = document.createElement("td");
          if (date.monowave == "EMpty") {
            monowaveCell.textContent = "";
          } else {
            let FinalPrice = Math.abs(parseFloat(date.monowave.toFixed(3)));

            monowaveCell.textContent = FinalPrice;
          }
          row.appendChild(monowaveCell);

          const retracementCell = document.createElement("td");
          if (date.retracement == "EMpty") {
            retracementCell.textContent = "";
          } else {
            let FinalPrice = parseFloat(date.retracement.toFixed(3));

            retracementCell.textContent = `${FinalPrice}(%)`;
          }
          row.appendChild(retracementCell);

          // Append the row to the table body
          tableBody.appendChild(row);
        });
      }
      async function fetchData(apiOptions, stDate, enDate,nameInput) {
        try {
          const response = await fetch(
            `https://sharemarketn.onrender.com/api/fetchData/${apiOptions}?startDate=${stDate}&endDate=${enDate}&nameInput=${nameInput}`
          );

          const data = await response.json();
          return data.data; // Assuming your data is in the 'data' property
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      }

      // Function to draw a line chart for Open and Close values
      async function drawLineChart(apiOptions, stDate, enDate,nameInput) {
        document.getElementById("loadingIndicator").style.display = "block"; // Show loading indicator
        const canvas = document.getElementById("lineChart");

        const apiData = await fetchData(apiOptions, stDate, enDate,nameInput);
        let openPrices = new Array();
        const newDates = new Array();
        let lossProfitArray = new Array();
        let filllossProfitArray = 0;
        let BIGCOUNTER = 0;
        let ss = 0;
        let a = 0;
        let filler = 1;
        let YYYY = 1;
        let MonowaveArray = new Array();
        let Run = 1;
        let fillMonowaveArray = 1;
        MonowaveArray[0] = "EMpty";
        let plus_sum = 0;
        let minus_sum = 0;

        for (let i = 0; i < apiData.length; i++) {
          newDates[ss] = new Date(apiData[i]["Date"]);
          ss++;
          newDates[ss] = new Date(apiData[i]["Date"]);
          ss++;
          let open = parseFloat(apiData[i]["Open"]);
          let close = parseFloat(apiData[i]["Close"]);
          if (open > close) {
            openPrices[a] = parseFloat(apiData[i]["High"]);
            a++;
            openPrices[a] = parseFloat(apiData[i]["Low"]);
            a++;
          } else if (open < close) {
            openPrices[a] = parseFloat(apiData[i]["Low"]);
            a++;
            openPrices[a] = parseFloat(apiData[i]["High"]);
            a++;
          } else {
            openPrices[a] = parseFloat(apiData[i]["Low"]);
            a++;
            openPrices[a] = parseFloat(apiData[i]["High"]);
            a++;
          }
          if (i == 0) {
            lossProfitArray[filllossProfitArray] = "EMpty";
            filllossProfitArray++;
          } else {
            lossProfitArray[filllossProfitArray] =
              openPrices[filler] - openPrices[filler - 1];
            filler++;
            filllossProfitArray++;
            lossProfitArray[filllossProfitArray] =
              openPrices[filler] - openPrices[filler - 1];
            filler++;
            filllossProfitArray++;
          }
        }

        lossProfitArray[filllossProfitArray] =
          openPrices[filler] - openPrices[filler - 1];

        // Fill the monoWave Array

        while (Run < lossProfitArray.length) {
          if (lossProfitArray[Run] > 0) {
            let start = Run;
            let end = Run;
            let sum = 0;
            let a = end;
            while (lossProfitArray[end] > 0) {
              if (a != end) {
                MonowaveArray[fillMonowaveArray] = "EMpty";
                fillMonowaveArray++;
              }
              sum += lossProfitArray[end];
              end++;
            }
            if (sum == 0) {
              sum = Math.abs(lossProfitArray[start]);
            }
            MonowaveArray[fillMonowaveArray] = Math.abs(sum);
            fillMonowaveArray++;
            Run = end;
          } else if (lossProfitArray[Run] < 0) {
            let start = Run;
            let end = Run;
            let sum = 0;
            let a = end;
            while (lossProfitArray[end] < 0) {
              if (a != end) {
                MonowaveArray[fillMonowaveArray] = "EMpty";
                fillMonowaveArray++;
              }
              sum += lossProfitArray[end];
              end++;
            }
            if (sum == 0) {
              sum = Math.abs(lossProfitArray[start]);
            }
            MonowaveArray[fillMonowaveArray] = Math.abs(sum);
            fillMonowaveArray++;
            Run = end;
          } else {
            MonowaveArray[fillMonowaveArray] = "EMpty";
            fillMonowaveArray++;
            Run++;
          }
        }

        let index = 0;
        for (let i = 0; i < MonowaveArray.length; i++) {
          if (MonowaveArray[i] != "EMpty") {
            index = i;
            break;
          }
        }

        //Retracement
        let LabelsArray = new Array();
        let dddd = 0;
        let RetracementArray = new Array();
        for (let i = 0; i <= index; i++) {
          RetracementArray[i] = "EMpty";
          LabelsArray[dddd] = {
            date: newDates[i],
            persontage: "",
            value: openPrices[i],
          };
          dddd++;
        }

        for (let i = index + 1; i < MonowaveArray.length; i++) {
          if (MonowaveArray[i] == "EMpty") {
            RetracementArray[i] = "EMpty";
            LabelsArray[dddd] = {
              date: newDates[i],
              persontage: "",
              value: openPrices[i],
            };
            dddd++;
          } else {
            if (MonowaveArray[i - 1] != "EMpty") {
              RetracementArray[i] = Math.abs(
                (MonowaveArray[i] * 100) / MonowaveArray[i - 1]
              );
              LabelsArray[dddd] = {
                date: newDates[i],
                persontage: parseFloat(RetracementArray[i].toFixed(3)),
                value: openPrices[i],
              };
              dddd++;
            } else {
              let find = i - 1;
              while (MonowaveArray[find] == "EMpty") {
                find--;
              }
              RetracementArray[i] = Math.abs(
                (MonowaveArray[i] * 100) / MonowaveArray[find]
              );
              LabelsArray[dddd] = {
                date: newDates[i],
                persontage: parseFloat(RetracementArray[i].toFixed(3)),
                value: openPrices[i],
              };
              dddd++;
            }
          }
        }

        const ctx = document.getElementById("lineChart").getContext("2d");
        if (window.myChart) {
          window.myChart.destroy();
        }

        // Create the chart
        window.myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: LabelsArray.map(() => ""), // Empty strings for x-axis labels
            datasets: [
              {
                label: "Value",
                data: openPrices.map((open) => open),
                borderColor: "blue",
                borderWidth: 2,
                pointBackgroundColor: "black",
                fill: false,
                pointRadius: 1,
                pointHoverRadius: 2,
                showLine: true,
              },
            ],
          },
          options: {
            scales: {
              x: {
                ticks: {
                  callback: function (value, index, values) {
                    // Use LabelsArray to get the date for x-axis label
                    const dateString =
                      LabelsArray[index].date.toLocaleDateString();
                    return dateString;
                  },
                },
              },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const dateObject = LabelsArray[context.dataIndex].date;
                    const dateString = dateObject.toLocaleDateString();
                    const percentageValue =
                      LabelsArray[context.dataIndex].persontage;
                    const value = parseFloat(
                      LabelsArray[context.dataIndex].value.toFixed(2)
                    );

                    if (!percentageValue) {
                      return `value ${value} date ${dateString}`;
                    } else {
                      return `value ${value} date ${dateString} percentage ${percentageValue}%`;
                    }
                  },
                },
              },
            },
          },
        });
        document.getElementById("loadingIndicator").style.display = "none"; // Hide loading indicator
        canvas.style.display = "block";
        fillTable(
          newDates,
          openPrices,
          lossProfitArray,
          MonowaveArray,
          RetracementArray
        );
      }

      function generateDateChart() {
        const startDate = document.getElementById("startDate").value;
        const endDate = document.getElementById("endDate").value;
        let selectedOption = document.getElementById("mySelect").value;
        let nameInput = document.getElementById('name').value;


        if (selectedOption == "option2") {
          selectedOption = "weekly";
        }
        if (selectedOption == "option3") {
          selectedOption = "daily";
        }
        if (selectedOption == "option1") {
          selectedOption = "monthly";
        }

        // Call the function to draw the line chart with these values
        drawLineChart(selectedOption, startDate, endDate,nameInput);
      }
      function clearDateInputs() {
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
      }
      window.onload = clearDateInputs;
    </script>
  </body>
</html>
